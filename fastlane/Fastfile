default_platform(:android)

platform :android do
  desc "Distribute a new build to Firebase Distribute"
  lane :distribute do
      is_pr = ENV["GITHUB_EVENT_NAME"] == "pull_request"

      version_name = if is_pr
          branch_name = ENV["GITHUB_HEAD_REF"] || ""
          branch_name.include?("/") ? branch_name.split("/").last : branch_name
        else
          "dev"
        end

      commit_count = 1
      if is_pr && ENV["GITHUB_EVENT_PATH"]
          begin
              file = File.read(ENV["GITHUB_EVENT_PATH"])
              event_data = JSON.parse(file)
              commit_count = event_data["pull_request"]["commits"] || 1
          rescue => e
              UI.error("Failed to parse GitHub event JSON: #{e.message}")
              commit_count = 1
          end
      end

      UI.message("Branch: #{version_name} | Commits in PR: #{commit_count}")

      gradle(
        task: "assemble",
        build_type: "Release",
        properties: {
            "environment" => "dev",
            "versionNameSuffix" => version_name
        }
      )

      changelog_from_git_commits(
        commits_count: commit_count,
        pretty: "* %s (%an)",
        merge_commit_filtering: "exclude_merges"
      )

      release = firebase_app_distribution(
        app: ENV["APP_ID"],
        service_credentials_file: "firebase_distribution.json",
        release_notes: lane_context[SharedValues::FL_CHANGELOG]
      )
  end

  desc "Deploy a new version to the Google Play"
  lane :deploy do
    gradle(task: "clean assembleRelease")
    upload_to_play_store
  end
end
